@if (loading()) {
<div class="os-budget-tracker os-budget-tracker--loading">
    <div class="os-budget-tracker__loading">
        <os-spinner [variant]="'default'"
            [size]="size() === 'large' ? 'md' : size() === 'medium' ? 'sm' : 'xs'"></os-spinner>
        <span class="os-budget-tracker__loading-text">Carregando dados do orçamento...</span>
    </div>
</div>
} @else if (budgetData(); as data) {
<os-card [variant]="variant() === 'compact' ? 'flat' : 'default'" [size]="size()" [clickable]="clickable()"
    (click)="onCardClick()"
    [class]="'os-budget-tracker os-budget-tracker--' + variant() + ' os-budget-tracker--' + size()">

    <!-- Header -->
    <div class="os-budget-tracker__header">
        <div class="os-budget-tracker__title-section">
            <h3 class="os-budget-tracker__title">{{ data.name }}</h3>
            @if (data.category) {
            <span class="os-budget-tracker__category">{{ data.category }}</span>
            }
        </div>

        <div class="os-budget-tracker__actions">
            @if (showStatus()) {
            <os-badge [variant]="statusInfo().type" [size]="size() === 'large' ? 'md' : 'sm'">
                <os-icon [name]="statusInfo().icon" [size]="size() === 'large' ? 'md' : 'sm'"></os-icon>
                {{ statusInfo().label }}
            </os-badge>
            }

            <div class="os-budget-tracker__action-buttons">
                <button class="os-budget-tracker__action-btn" (click)="onRefreshClick()"
                    [attr.aria-label]="'Atualizar dados do orçamento'">
                    <os-icon name="refresh" [size]="size() === 'large' ? 'md' : 'sm'"></os-icon>
                </button>
                <button class="os-budget-tracker__action-btn" (click)="onExportClick()"
                    [attr.aria-label]="'Exportar dados do orçamento'">
                    <os-icon name="download" [size]="size() === 'large' ? 'md' : 'sm'"></os-icon>
                </button>
            </div>
        </div>
    </div>

    <!-- Progress Section -->
    <div class="os-budget-tracker__progress">
        <div class="os-budget-tracker__progress-header">
            <span class="os-budget-tracker__progress-label">Progresso do Orçamento</span>
            <span class="os-budget-tracker__progress-percentage">{{ progressPercentage() }}%</span>
        </div>

        <os-progress-bar [value]="progressPercentage()"
            [variant]="isOverBudget() ? 'danger' : isCompleted() ? 'success' : 'primary'" [size]="size()">
        </os-progress-bar>
    </div>

    <!-- Financial Summary -->
    <div class="os-budget-tracker__financial">
        <div class="os-budget-tracker__amount-group">
            <div class="os-budget-tracker__amount">
                <span class="os-budget-tracker__amount-label">Orçamento Total</span>
                <os-money-display [value]="data.totalBudget" [variant]="'default'" [size]="size()"></os-money-display>
            </div>

            <div class="os-budget-tracker__amount">
                <span class="os-budget-tracker__amount-label">Gasto</span>
                <os-money-display [value]="data.spentAmount" [variant]="isOverBudget() ? 'error' : 'default'"
                    [size]="size()"></os-money-display>
            </div>

            <div class="os-budget-tracker__amount">
                <span class="os-budget-tracker__amount-label">Restante</span>
                <os-money-display [value]="data.remainingAmount"
                    [variant]="data.remainingAmount >= 0 ? 'success' : 'error'" [size]="size()"></os-money-display>
            </div>
        </div>
    </div>

    <!-- Trends Section -->
    @if (showTrends() && trendInfo(); as trend) {
    <div class="os-budget-tracker__trends">
        <div class="os-budget-tracker__trend-header">
            <os-icon [name]="trend.icon" [size]="size() === 'large' ? 'md' : 'sm'"></os-icon>
            <span class="os-budget-tracker__trend-label">Tendência de Gastos</span>
        </div>

        <div class="os-budget-tracker__trend-info">
            <span class="os-budget-tracker__trend-value" [style.color]="trend.color">
                {{ trend.label }}
            </span>
            <os-badge
                [variant]="trend.riskLevel === 'high' ? 'error' : trend.riskLevel === 'medium' ? 'warning' : 'success'"
                [size]="size() === 'large' ? 'md' : 'sm'">
                Risco {{ trend.riskLevel === 'high' ? 'Alto' : trend.riskLevel === 'medium' ? 'Médio' : 'Baixo' }}
            </os-badge>
        </div>
    </div>
    }

    <!-- Projections Section -->
    @if (showProjections() && projectionInfo(); as projection) {
    <div class="os-budget-tracker__projections">
        <div class="os-budget-tracker__projection-header">
            <os-icon name="trending_up" [size]="size() === 'large' ? 'md' : 'sm'"></os-icon>
            <span class="os-budget-tracker__projection-label">Projeção</span>
        </div>

        <div class="os-budget-tracker__projection-info">
            <os-money-display [value]="projection.value" [variant]="projection.isOver ? 'error' : 'default'"
                [size]="size()"></os-money-display>
            <span class="os-budget-tracker__projection-percentage">
                {{ projection.percentage.toFixed(1) }}% do orçamento
            </span>
        </div>
    </div>
    }

    <!-- Monthly Chart (only for detailed variant) -->
    @if (variant() === 'detailed' && showCharts() && monthlyData().length > 0) {
    <div class="os-budget-tracker__chart">
        <div class="os-budget-tracker__chart-header">
            <os-icon name="bar_chart" [size]="size() === 'large' ? 'md' : 'sm'"></os-icon>
            <span class="os-budget-tracker__chart-label">Gastos Mensais (Últimos 6 meses)</span>
        </div>

        <div class="os-budget-tracker__chart-bars">
            @for (month of monthlyData(); track month.month + month.year) {
            <div class="os-budget-tracker__chart-bar">
                <div class="os-budget-tracker__chart-bar-fill" [style.height.%]="month.percentage"
                    [class.os-budget-tracker__chart-bar-fill--high]="month.percentage > 80">
                </div>
                <span class="os-budget-tracker__chart-bar-label">
                    {{ getMonthName(month.month) }}/{{ month.year.toString().slice(-2) }}
                </span>
                <span class="os-budget-tracker__chart-bar-value">
                    {{ month.percentage.toFixed(0) }}%
                </span>
            </div>
            }
        </div>
    </div>
    }

    <!-- Dates Section (only for detailed variant) -->
    @if (variant() === 'detailed' && formattedDates(); as dates) {
    <div class="os-budget-tracker__dates">
        <div class="os-budget-tracker__date-item">
            <os-icon name="calendar_today" size="sm"></os-icon>
            <span class="os-budget-tracker__date-label">Início:</span>
            <span class="os-budget-tracker__date-value">{{ dates.start }}</span>
        </div>

        <div class="os-budget-tracker__date-item">
            <os-icon name="event" size="sm"></os-icon>
            <span class="os-budget-tracker__date-label">Fim:</span>
            <span class="os-budget-tracker__date-value">{{ dates.end }}</span>
        </div>

        <div class="os-budget-tracker__date-item">
            <os-icon name="update" size="sm"></os-icon>
            <span class="os-budget-tracker__date-label">Atualizado:</span>
            <span class="os-budget-tracker__date-value">{{ dates.lastUpdated }}</span>
        </div>
    </div>
    }

    <!-- Compact variant additional info -->
    @if (variant() === 'compact') {
    <div class="os-budget-tracker__compact-info">
        <span class="os-budget-tracker__compact-percentage">{{ progressPercentage() }}%</span>
        <span class="os-budget-tracker__compact-status" [style.color]="getStatusColor()">
            {{ statusInfo().label }}
        </span>
        @if (trendInfo(); as trend) {
        <span class="os-budget-tracker__compact-trend" [style.color]="trend.color">
            {{ trend.label }}
        </span>
        }
    </div>
    }
</os-card>
}